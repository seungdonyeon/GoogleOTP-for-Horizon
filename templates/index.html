{% extends "base.html" %}
{% set title = "OTP Hub Admin ‚Ä¢ Dashboard" %}

{% block content %}
  <div class="layout">
    <!-- Left: context + action catalog -->
    <div class="panel">
      <div class="hd">
        <p class="h1">Dashboard</p>
      </div>
      <div class="bd">
        <div class="card">
          <div class="kv">
            <div>Domain</div>
            <div><code>{{ domain }}</code></div>
            <div>QR TTL (created)</div>
            <div><code>{{ current_ttl_label }}</code></div>
            <div>QR TTL (after click)</div>
            <div><code>{{ current_click_ttl_label }}</code></div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">Actions</div>
          <div class="btnrow">
            <button form="mainForm" class="btn" name="action" value="add">‚ûï Add account</button>
            <button form="mainForm" class="btn primary" name="action" value="qr_link">üßæ Create QR link</button>
            <button form="mainForm" class="btn" name="action" value="change">üîÑ Rotate OTP</button>
            <button form="mainForm" class="btn danger" name="action" value="delete"
                    data-confirm="Delete OTP for this account? This cannot be undone.">üóëÔ∏è Delete OTP</button>
            <button form="mainForm" class="btn" name="action" value="list">üìã List accounts</button>
          </div>
<div class="help" style="margin-top:10px;">
            Destructive actions will ask for confirmation. Most commands require an <b>account ID</b>.
          </div>
        </div>

        <hr class="sep">

        <div class="section">
          <div class="section-title">Actions with AD</div>
          <div class="btnrow" style="grid-template-columns:1fr;">
            <button form="mainForm" class="btn" name="action" value="extract_users">üßæ Export AD user list</button>
            <button form="mainForm" class="btn" name="action" value="check_missing_otp">üîç Find accounts without OTP</button>
            <button form="mainForm" class="btn" name="action" value="generate_missing_otp"
                    data-confirm="Generate OTP for ALL accounts missing OTP? This may take time.">üõ†Ô∏è Generate OTP for all missing</button>
          </div>
          <div class="help" style="margin-top:10px;">
            Exported user list is stored under the project directory in a folder named after the domain.
          </div>
        </div>
      </div>
    </div>

    <!-- Right: main form + results -->
    <div class="panel">
      <div class="hd">
        <p class="h1">OTP account operations</p>
      </div>
      <div class="bd">
        <form id="mainForm" method="post">
          <div class="card">
            <label for="uid">Account ID</label>
            <input id="uid" type="text" name="uid" placeholder="e.g., test01,test02,test03" autocomplete="off">
            <div class="help" style="margin-top:8px;">
            </div>
            <div class="help" style="margin-top:8px;">
            </div>

            <div class="section">
              <div class="section-title">QR link TTL settings</div>

              <div class="card" style="padding:12px; margin-bottom:10px;">
                <div class="inline">
                  <div class="pill">Created-at TTL</div>
                  <div class="grow">
                    <select name="ttl">
                      {% for label, val in ttl_options %}
                        <option value="{{ val }}" {% if val == current_ttl_val %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <button class="btn small" type="submit" name="action" value="set_ttl">Apply</button>
                </div>
                <div class="help" style="margin-top:8px;">
                  Link expires after this duration from creation time (regardless of click).
                </div>
              </div>

              <div class="card" style="padding:12px;">
                <div class="inline">
                  <div class="pill">After-click TTL</div>
                  <div class="grow">
                    <select name="click_ttl">
                      {% for label, val in click_ttl_options %}
                        <option value="{{ val }}" {% if val == current_click_ttl_val %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <button class="btn small" type="submit" name="action" value="set_click_ttl">Apply</button>
                </div>
                <div class="help" style="margin-top:8px;">
                  Link becomes invalid this long after the <b>first successful view</b>.
                </div>
              </div>
            </div>

            
          </div>
        </form>

        <div class="section">
          <div class="section-title">
            <span>Result</span>
            <div class="inline">
              <button id="btnCopyQR" class="btn small" type="button" style="display:none;">QR Copy</button>
            </div>
          </div>
          <pre id="resultBox" class="output">{{ result }}</pre>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
